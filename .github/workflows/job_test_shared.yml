name: Test Shared

on:
  workflow_call:

jobs:
  test-shared:
    name: Run Shared Tests
    runs-on: macos-26

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: "26.0"

    - name: Cache SwiftPM
      uses: actions/cache@v3
      with:
        path: ~/Shared/Caches/org.swift.swiftpm
        key: ${{ runner.os }}-swiftpm-${{ hashFiles('Shared/Package.resolved') }}
        restore-keys: ${{ runner.os }}-swiftpm-

    - name: Cache SwiftPM build artifacts
      uses: actions/cache@v3
      with:
        path: Shared/.build
        key: ${{ runner.os }}-spm-build-${{ hashFiles('Shared/Package.swift', 'Shared/Package.resolved') }}
        restore-keys: ${{ runner.os }}-spm-build-

    # ✅ Sharedモジュールのテストのみ実行
    - name: Build Shared Tests
      working-directory: Shared
      run: swift build --build-tests

    - name: Run Shared Tests
      working-directory: Shared
      run: swift test --filter SharedTests --parallel --enable-code-coverage

    - name: Upload Test Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: shared-test-results
        path: Shared/.build/debug/codecov/
