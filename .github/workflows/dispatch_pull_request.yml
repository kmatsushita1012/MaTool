name: Pull Request

on:
  workflow_dispatch:
  pull_request:
    branches: 
      - main

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      backend_changed: ${{ steps.filter.outputs.backend }}
      iosapp_changed: ${{ steps.filter.outputs.iosapp }}
      shared_changed: ${{ steps.filter.outputs.shared }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # 差分検出のため履歴が必要

      - name: Detect changes
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            backend:
              - 'Backend/Sources/**'
              - 'Backend/Tests/**'
            iosapp:
              - 'iOSApp/Sources/**'
              - 'iOSApp/Tests/**'
            shared:
              - 'Shared/Sources/**'
              - 'Shared/Tests/**'

  # ==== Backend テスト (Backend 変更 or Shared 変更時) ====
  backend-tests:
    needs: detect-changes
    if: ${{ needs.detect-changes.outputs.backend_changed == 'true' || needs.detect-changes.outputs.shared_changed == 'true' }}
    uses: ./.github/workflows/job_test_backend.yml

  # ==== iOSApp テスト (iOSApp 変更 or Shared 変更時) ====
  iosapp-tests:
    needs: detect-changes
    if: ${{ needs.detect-changes.outputs.iosapp_changed == 'true' || needs.detect-changes.outputs.shared_changed == 'true' }}
    uses: ./.github/workflows/job_test_iosapp.yml

  # ==== 条件付きでSharedテスト ====
  shared-tests:
    needs: detect-changes
    if: ${{ needs.detect-changes.outputs.shared_changed == 'true' }}
    uses: ./.github/workflows/job_test_shared.yml
