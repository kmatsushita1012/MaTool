name: Deploy Lambda

on:
  push:
    branches:
      - release-backend
      - 'backend/**'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      AWS_REGION: ${{ secrets.AWS_REGION }}
      LAMBDA_ARN: ${{ secrets.LAMBDA_ARN }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build Lambda binary with Dockerfile
        run: |
          docker build -t matoolapi .
          docker create --name extract matoolapi
          docker cp extract:/var/runtime/bootstrap ./bootstrap
          docker rm extract
          chmod +x bootstrap
          zip lambda.zip bootstrap

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Set stage name
        id: set_stage
        run: |
          BRANCH=${GITHUB_REF_NAME//\//-}
          if [[ "$BRANCH" == backend-* ]]; then
            STAGE_NAME="dev-${BRANCH#backend-}"
          elif [[ "$BRANCH" == "release-backend" ]]; then
            STAGE_NAME="prod"
          elif [[ "$BRANCH" == "main" ]]; then
            STAGE_NAME="dev"
          else
            STAGE_NAME="$BRANCH"
          fi

          echo "Resolved stage name: $STAGE_NAME"
          echo "stage=$STAGE_NAME" >> $GITHUB_OUTPUT

      - name: Deploy Lambda Function
        run: |
          FUNCTION_NAME="MaToolAPIv2"
          STAGE_NAME=${{ steps.set_stage.outputs.stage }}

          echo "Deploying Lambda: $FUNCTION_NAME"

          aws lambda update-function-code \
            --function-name "$FUNCTION_NAME" \
            --zip-file fileb://lambda.zip

          sleep 10

          # Êñ∞„Åó„ÅÑ„Éê„Éº„Ç∏„Éß„É≥„ÇíÁô∫Ë°å
          VERSION=$(aws lambda publish-version --function-name "$FUNCTION_NAME" --query 'Version' --output text)
          echo "Published new version: $VERSION"

          # „Éñ„É©„É≥„ÉÅÂêç„Çí„Ç®„Ç§„É™„Ç¢„Çπ„Å´Á¥ê‰ªò„Åë
          aws lambda update-alias \
            --function-name "$FUNCTION_NAME" \
            --name "$STAGE_NAME" \
            --function-version "$VERSION" 2>/dev/null \
            || aws lambda create-alias \
              --function-name "$FUNCTION_NAME" \
              --name "$STAGE_NAME" \
              --function-version "$VERSION"

          echo "Lambda alias '$STAGE_NAME' now points to version $VERSION"

      - name: Deploy API Gateway Stage (v2)
        env:
          AWS_REGION: ${{ secrets.AWS_REGION }}
          API_GATEWAY_ID: ${{ secrets.API_GATEWAY_ID }}
          LAMBDA_FUNCTION_NAME: "MaToolAPIv2"
          ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
        run: |
          set -e
          
          STAGE_NAME=${{ steps.set_stage.outputs.stage }}
          echo "üöÄ Deploying API Gateway for stage: $STAGE_NAME"

          # --- Get Lambda alias ARN ---
          FUNCTION_ALIAS_ARN=$(aws lambda get-alias \
            --function-name "$LAMBDA_FUNCTION_NAME" \
            --name "$STAGE_NAME" \
            --query 'AliasArn' \
            --output text)
          
          echo "Lambda alias ARN: $FUNCTION_ALIAS_ARN"

          # --- Check if integration for this stage already exists ---
          INTEGRATION_ID=$(aws apigatewayv2 get-integrations \
            --api-id "$API_GATEWAY_ID" \
            --query "Items[?contains(IntegrationUri, ':${STAGE_NAME}/invocations')].IntegrationId" \
            --output text)
          
          echo "Existing Integration ID: $INTEGRATION_ID"

          if [ -z "$INTEGRATION_ID" ]; then
            echo "üÜï No integration found for $STAGE_NAME. Creating new one..."
            INTEGRATION_ID=$(aws apigatewayv2 create-integration \
              --api-id "$API_GATEWAY_ID" \
              --integration-type AWS_PROXY \
              --integration-method POST \
              --integration-uri "arn:aws:apigateway:${AWS_REGION}:lambda:path/2015-03-31/functions/${FUNCTION_ALIAS_ARN}/invocations" \
              --payload-format-version 2.0 \
              --query 'IntegrationId' \
              --output text)
            echo "‚úÖ Integration created: $INTEGRATION_ID"

            echo "üÜï Creating route for stage: $STAGE_NAME"

            if [ "$STAGE_NAME" = "prod" ]; then
              ROUTE_KEY="ANY /{proxy+}"
            else
              ROUTE_KEY="ANY /${STAGE_NAME}/{proxy+}"
            fi

            aws apigatewayv2 create-route \
              --api-id "$API_GATEWAY_ID" \
              --route-key "$ROUTE_KEY" \
              --target "integrations/${INTEGRATION_ID}"

            echo "‚úÖ Route created: $ROUTE_KEY"
            
          else
            echo "‚ôªÔ∏è Integration already exists: $INTEGRATION_ID"
          fi

          # --- Deploy $default stage (auto-deploy disabled systems) ---
          echo "üöÄ Deploying $default stage..."
          DEPLOY_ID=$(aws apigatewayv2 create-deployment \
            --api-id "$API_GATEWAY_ID" \
            --description "Deployment for $" \
            --query 'DeploymentId' \
            --output text)

          aws apigatewayv2 update-stage \
            --api-id "$API_GATEWAY_ID" \
            --stage-name '$default' \
            --deployment-id "$DEPLOY_ID"

          echo "‚úÖ $default stage deployed successfully"
