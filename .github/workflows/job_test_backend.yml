name: Test Backend

on:
  workflow_call:

jobs:
  test-backend:
    name: Run Backend Tests
    runs-on: macos-26

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: "26.0"

    - name: Cache SwiftPM
      uses: actions/cache@v3
      with:
        path: ~/Library/Caches/org.swift.swiftpm
        key: ${{ runner.os }}-swiftpm-${{ hashFiles('Library/Package.resolved') }}
        restore-keys: ${{ runner.os }}-swiftpm-
          
    - name: Cache SwiftPM build artifacts
      uses: actions/cache@v3
      with:
        path: Library/.build
        key: ${{ runner.os }}-spm-build-${{ hashFiles('Library/Package.swift', 'Library/Package.resolved') }}
        restore-keys: ${{ runner.os }}-spm-build-

    - name: Build and Run Backend Tests
      working-directory: Library
      run: swift test --target Backend --parallel --enable-code-coverage


    - name: Upload Test Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: backend-test-results
        path: Library/.build/debug/codecov/

    - name: Collect & Format Backend Test Results
      if: always()
      working-directory: Library
      run: |
        echo ""
        echo "===== Test Results Summary ====="

        # coverage JSON ã®å–å¾—ï¼ˆfind ã§ 1 ä»¶ã ã‘å–ã‚‹ï¼‰
        result_file=$(find .build -type f -path "*/debug/codecov/*.json" | head -n 1)

        if [ -z "$result_file" ]; then
          echo "âŒ No coverage/test result found!"
          exit 1
        fi

        # ãƒ†ã‚¹ãƒˆæ•°ã‚’æŠ½å‡º
        total=$(jq '.targets[].files[].functions | length' "$result_file" | awk '{s+=$1} END{print s+0}')
        passed=$(jq '.targets[].files[].functions[] | select(.coveredLines > 0)' "$result_file" | wc -l | tr -d ' ')
        failed=$((total - passed))

        # SwiftPM ã®æ¨™æº–ãƒ­ã‚°ã‹ã‚‰å¤±æ•—ãƒ†ã‚¹ãƒˆã‚’æ‹¾ã†
        FAILED_LOG="backend_failed_tests.txt"
        find .build -type f -name "*.test" -exec grep -EH "error:|failed" {} \; | sed 's/^/âœ˜ /' > "$FAILED_LOG" || true

        echo ""
        echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ğŸ“‹ Environment â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
        echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
        printf "â”‚ %-20s â”‚ %-26s â”‚\n" "Runner" "GitHub Actions"
        printf "â”‚ %-20s â”‚ %-26s â”‚\n" "SwiftPM" "$(swift --version | head -n 1)"
        echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"

        echo ""
        echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ğŸ“Š Test Counts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
        echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
        printf "â”‚ %-11s â”‚ %4s         â”‚\n" "Passed" "$passed"
        printf "â”‚ %-11s â”‚ %4s         â”‚\n" "Failed" "$failed"
        printf "â”‚ %-11s â”‚ %4s         â”‚\n" "Total" "$total"
        echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"

        if [ -s "$FAILED_LOG" ]; then
          echo ""
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€âŒ Failed Tests â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          cat "$FAILED_LOG"
          exit 1
        else
          echo ""
          echo "âœ… All backend tests passed"
        fi

