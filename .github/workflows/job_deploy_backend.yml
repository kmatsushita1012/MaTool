name: Deploy Lambda

on:
  workflow_call:

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      AWS_REGION: ${{ secrets.AWS_REGION }}
      LAMBDA_ARN: ${{ secrets.LAMBDA_ARN }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Build Lambda binary with Dockerfile
        # build context „ÅØ„É™„Éù„Ç∏„Éà„É™„É´„Éº„ÉàÔºàShared „ÇíÂê´„ÇÅ„ÇãÔºâ
        run: |
          # Backend/Dockerfile „Çí‰Ωø„Å£„Å¶„É´„Éº„Éà„Çí„Ç≥„É≥„ÉÜ„Ç≠„Çπ„Éà„Å´„Éì„É´„Éâ
          docker build -t matoolapi -f Backend/Dockerfile .

          # „Ç§„É°„Éº„Ç∏„Åã„Çâ bootstrap „ÇíÊäΩÂá∫ÔºàLambdaÁî®„ÅÆÊúÄÂ∞èÂÆüË°å„Éï„Ç°„Ç§„É´Âêç„Åå bootstrap „ÅÆÂ†¥ÂêàÔºâ
          docker create --name extract matoolapi
          docker cp extract:/var/runtime/bootstrap ./bootstrap || true
          docker rm extract || true

          # Â¶ÇÊûú bootstrap „Åå PATH „Å´„Å™„ÅÑÂ†¥Âêà„ÇÑ„ÄÅÂà•„ÅÆÂ†¥ÊâÄ„Å´„ÅÇ„Çã„Å™„Çâ Dockerfile ÂÅ¥„ÅßÈÖçÁΩÆ„ÇíÂêà„Çè„Åõ„Å¶„Åè„Å†„Åï„ÅÑ
          if [ -f ./bootstrap ]; then
            chmod +x ./bootstrap
            zip -r lambda.zip bootstrap
          else
            echo "Error: bootstrap not found in image. Inspect Dockerfile and image layout."
            exit 1
          fi

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Set stage name
        id: set_stage
        run: |
          BRANCH=${GITHUB_REF_NAME//\//-}
          if [[ "$BRANCH" == backend-* ]]; then
            STAGE_NAME="dev-${BRANCH#backend-}"
          elif [[ "$BRANCH" == "release-backend" ]]; then
            STAGE_NAME="prod"
          elif [[ "$BRANCH" == "main" ]]; then
            STAGE_NAME="dev"
          else
            STAGE_NAME="$BRANCH"
          fi
          echo "Resolved stage name: $STAGE_NAME"
          echo "stage=$STAGE_NAME" >> $GITHUB_OUTPUT

      - name: Deploy Lambda Function
        run: |
          FUNCTION_NAME="MaToolAPIv2"
          STAGE_NAME=${{ steps.set_stage.outputs.stage }}

          echo "Deploying Lambda: $FUNCTION_NAME"
          aws lambda update-function-code \
            --function-name "$FUNCTION_NAME" \
            --zip-file fileb://lambda.zip

          sleep 10

          VERSION=$(aws lambda publish-version --function-name "$FUNCTION_NAME" --query 'Version' --output text)
          echo "Published new version: $VERSION"

          aws lambda update-alias \
            --function-name "$FUNCTION_NAME" \
            --name "$STAGE_NAME" \
            --function-version "$VERSION" 2>/dev/null \
            || aws lambda create-alias \
              --function-name "$FUNCTION_NAME" \
              --name "$STAGE_NAME" \
              --function-version "$VERSION"

          echo "Lambda alias '$STAGE_NAME' now points to version $VERSION"

      - name: Deploy API Gateway Stage (v2)
        env:
          AWS_REGION: ${{ secrets.AWS_REGION }}
          API_GATEWAY_ID: ${{ secrets.API_GATEWAY_ID }}
          LAMBDA_FUNCTION_NAME: "MaToolAPIv2"
          ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
        run: |
          set -e
          STAGE_NAME=${{ steps.set_stage.outputs.stage }}
          echo "üöÄ Deploying API Gateway for stage: $STAGE_NAME"

          FUNCTION_ALIAS_ARN=$(aws lambda get-alias \
            --function-name "$LAMBDA_FUNCTION_NAME" \
            --name "$STAGE_NAME" \
            --query 'AliasArn' \
            --output text)

          echo "Lambda alias ARN: $FUNCTION_ALIAS_ARN"

          INTEGRATION_ID=$(aws apigatewayv2 get-integrations \
            --api-id "$API_GATEWAY_ID" \
            --query "Items[?contains(IntegrationUri, ':${STAGE_NAME}/invocations')].IntegrationId" \
            --output text)

          echo "Existing Integration ID: $INTEGRATION_ID"

          if [ -z "$INTEGRATION_ID" ]; then
            echo "üÜï No integration found for $STAGE_NAME. Creating new one..."
            INTEGRATION_ID=$(aws apigatewayv2 create-integration \
              --api-id "$API_GATEWAY_ID" \
              --integration-type AWS_PROXY \
              --integration-method POST \
              --integration-uri "arn:aws:apigateway:${AWS_REGION}:lambda:path/2015-03-31/functions/${FUNCTION_ALIAS_ARN}/invocations" \
              --payload-format-version 2.0 \
              --query 'IntegrationId' \
              --output text)
            echo "‚úÖ Integration created: $INTEGRATION_ID"

            if [ "$STAGE_NAME" = "prod" ]; then
              ROUTE_KEY="ANY /{proxy+}"
            else
              ROUTE_KEY="ANY /${STAGE_NAME}/{proxy+}"
            fi

            aws apigatewayv2 create-route \
              --api-id "$API_GATEWAY_ID" \
              --route-key "$ROUTE_KEY" \
              --target "integrations/${INTEGRATION_ID}"

            echo "‚úÖ Route created: $ROUTE_KEY"
          else
            echo "‚ôªÔ∏è Integration already exists: $INTEGRATION_ID"
          fi

          DEPLOY_ID=$(aws apigatewayv2 create-deployment \
            --api-id "$API_GATEWAY_ID" \
            --description "Deployment" \
            --query 'DeploymentId' \
            --output text)

          aws apigatewayv2 update-stage \
            --api-id "$API_GATEWAY_ID" \
            --stage-name '$default' \
            --deployment-id "$DEPLOY_ID"

          echo "‚úÖ $default stage deployed successfully"
