name: Test Backend

on:
  workflow_dispatch:

jobs:
  test-backend:
    name: Run Backend Tests
    runs-on: macos-26

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: "26.0"

    - name: Cache SwiftPM
      uses: actions/cache@v3
      with:
        path: ~/Library/Caches/org.swift.swiftpm
        key: ${{ runner.os }}-swiftpm-${{ hashFiles('Library/Package.resolved') }}
        restore-keys: ${{ runner.os }}-swiftpm-
          
    - name: Cache SwiftPM build artifacts
      uses: actions/cache@v3
      with:
        path: Library/.build
        key: ${{ runner.os }}-spm-build-${{ hashFiles('Library/Package.swift', 'Library/Package.resolved') }}
        restore-keys: ${{ runner.os }}-spm-build-

    # ✅ Backendモジュールのテストのみ実行
    - name: Build Backend Tests
      working-directory: Library
      run: swift build --build-tests

    - name: Run Backend Tests
      working-directory: Library
      run: swift test --filter BackendTests --parallel --enable-code-coverage

    - name: Upload Test Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: backend-test-results
        path: Library/.build/debug/codecov/
